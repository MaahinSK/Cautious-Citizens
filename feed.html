<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Community Feed | Cautious Citizens</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
  <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .feed-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
    }

    .feed-header {
      text-align: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .post-form {
      background-color: #f8f8f8;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-family: Arial, sans-serif;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .upload-btn {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-bottom: 15px;
    }

    .upload-btn:hover {
      background-color: #45a049;
    }

    .submit-btn {
      background-color: #366de4;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }

    .submit-btn:hover {
      background-color: #2a56c7;
    }

    .preview-image {
      max-width: 100%;
      max-height: 200px;
      margin-top: 10px;
      border-radius: 5px;
      display: none;
    }

    .posts-container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
    }

    .post-card {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .post-image {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .post-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 0.9em;
      color: #555;
    }

    .post-author {
      font-weight: bold;
      color: #333;
    }

    .post-time {
      color: #999;
    }

    .post-location {
      color: #666;
      font-style: italic;
      margin-bottom: 10px;
    }

    .post-description {
      word-wrap: break-word;
      margin-bottom: 10px;
    }

    .no-posts {
      text-align: center;
      color: #666;
      padding: 20px;
    }

    /* New styles */
    .filter-section {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-section input, 
    .filter-section button {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .comments-btn {
      background: none;
      border: none;
      color: #366de4;
      cursor: pointer;
      padding: 5px 0;
      margin: 10px 0;
      display: block;
    }

    .comments-section {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
      background: #f9f9f9;
      border-radius: 0 0 8px 8px;
    }

    .comments-section.expanded {
      max-height: 500px;
      padding: 10px;
      margin-top: 10px;
    }

    .comment {
      padding: 8px;
      margin: 5px 0;
      background: white;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .comment-form {
      display: flex;
      margin-top: 10px;
    }

    .comment-input {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px 0 0 4px;
    }

    .comment-submit {
      padding: 0 15px;
      background: #366de4;
      color: white;
      border: none;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 80%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
    }

    .modal .close {
      position: absolute;
      right: 20px;
      top: 20px;
      font-size: 24px;
      cursor: pointer;
    }

    #statsChart {
      width: 100%;
      max-height: 400px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="left">
      <a href="index.html" class="logo-link">
        <h1 class="brand">Cautious Citizens</h1>
      </a>
    </div>
    <div class="center">
      <a href="admin.html">Admin</a>
      <a href="about.html">About Us</a>
      <a href="chat.html">Chat Board</a>
      <a href="profile.html">Profile</a>
      <a href="feed.html">Feed</a>
    </div>
    <div class="right" id="auth-buttons">
      <button id="loginBtn">Login</button>
      <button id="signupBtn">Sign Up</button>
    </div>
    <div class="right" id="user-info" style="display: none;">
      <span id="username-display"></span>
      <button id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="feed-container">
    <div class="feed-header">
      <h1>Community Feed</h1>
      <p>Share updates and see what's happening in your community</p>
    </div>
    
    <div class="post-form" id="postForm">
      <div class="form-group">
        <label for="postLocation">Location</label>
        <input type="text" id="postLocation" placeholder="Where is this happening?">
      </div>
      
      <div class="form-group">
        <label for="postDescription">Description</label>
        <textarea id="postDescription" placeholder="What's happening?"></textarea>
      </div>
      
      <button class="upload-btn" id="uploadImageBtn">Upload Image</button>
      <img id="imagePreview" class="preview-image" alt="Image preview">
      <input type="hidden" id="imageUrl">
      
      <button class="submit-btn" id="submitPost">Post to Feed</button>
    </div>

    <div class="filter-section">
      <input type="text" id="locationFilter" placeholder="Filter by location...">
      <input type="text" id="keywordFilter" placeholder="Filter by keyword...">
      <button id="applyFilter">Apply Filters</button>
      <button id="showStats">Show Statistics</button>
    </div>

    <div class="posts-container" id="postsContainer">
      <div class="no-posts">Loading posts...</div>
    </div>
  </div>

  <div id="statsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Post Statistics</h2>
      <canvas id="statsChart"></canvas>
    </div>
  </div>

  <script src="firebase-config.js"></script>
  <script>
    // Cloudinary configuration
    const cloudinaryConfig = {
      cloudName: 'dbkwnhwq1',
      uploadPreset: 'cautious_citizens_upload'
    };

    // Auth state handling
    auth.onAuthStateChanged((user) => {
      if (user) {
        document.getElementById("auth-buttons").style.display = "none";
        document.getElementById("user-info").style.display = "flex";
        db.collection("users").doc(user.uid).get().then(doc => {
          const name = doc.exists && doc.data().name ? doc.data().name : user.email;
          document.getElementById("username-display").innerText = name;
          initializeFeed(user);
        }).catch(error => {
          console.error("Error getting user data:", error);
          initializeFeed(user);
        });
      } else {
        window.location.href = "index.html";
      }
    });
     
    function showReportDialog(postId) {
  const reportReasons = [
    "Inappropriate content",
    "False information",
    "Spam",
    "Harassment",
    "Other"
  ];
  
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.style.display = 'block';
  modal.innerHTML = `
    <div class="modal-content" style="max-width: 500px;">
      <span class="close" style="cursor: pointer; float: right; font-size: 24px;">&times;</span>
      <h2>Report Post</h2>
      <p>Please select a reason for reporting this post:</p>
      <div id="reportReasons">
        ${reportReasons.map(reason => `
          <div>
            <input type="radio" id="reason-${reason.replace(/\s+/g, '-')}" name="reportReason" value="${reason}">
            <label for="reason-${reason.replace(/\s+/g, '-')}">${reason}</label>
          </div>
        `).join('')}
      </div>
      <div class="form-group" style="margin-top: 15px;">
        <label for="additionalInfo">Additional Information (optional):</label>
        <textarea id="additionalInfo" placeholder="Provide more details..." rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
      </div>
      <button id="submitReport" class="submit-btn" style="margin-top: 15px;">Submit Report</button>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close modal
  modal.querySelector('.close').addEventListener('click', () => {
    document.body.removeChild(modal);
  });
  
  // Close modal when clicking outside
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      document.body.removeChild(modal);
    }
  });
  
  // Submit report
  modal.querySelector('#submitReport').addEventListener('click', () => {
    const selectedReason = modal.querySelector('input[name="reportReason"]:checked');
    const additionalInfo = modal.querySelector('#additionalInfo').value;
    
    if (!selectedReason) {
      alert('Please select a reason for reporting this post.');
      return;
    }
    
    submitReport(postId, selectedReason.value, additionalInfo);
    document.body.removeChild(modal);
  });
}

async function submitReport(postId, reason, additionalInfo = '') {
  try {
    const user = auth.currentUser;
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};
    
    await db.collection('reports').add({
      postId,
      reason,
      additionalInfo,
      reporterId: user.uid,
      reporterName: userData.name || user.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    alert('Thank you for your report. Our team will review it shortly.');
  } catch (error) {
    console.error("Error submitting report:", error);
    alert("Error submitting report. Please try again.");
  }
}

    function initializeFeed(user) {
      const uploadImageBtn = document.getElementById("uploadImageBtn");
      const imagePreview = document.getElementById("imagePreview");
      const imageUrlInput = document.getElementById("imageUrl");
      const submitPostBtn = document.getElementById("submitPost");
      const postsContainer = document.getElementById("postsContainer");
      const applyFilterBtn = document.getElementById('applyFilter');
      const showStatsBtn = document.getElementById('showStats');
      const statsModal = document.getElementById('statsModal');
      const closeModal = document.querySelector('#statsModal .close');
      let statsChart = null;

      // Initialize Cloudinary widget
      let cloudinaryWidget = cloudinary.createUploadWidget({
        cloudName: cloudinaryConfig.cloudName,
        uploadPreset: cloudinaryConfig.uploadPreset,
        sources: ['local', 'url', 'camera'],
        multiple: false,
        clientAllowedFormats: ['jpg', 'png', 'jpeg'],
        maxImageFileSize: 5000000,
        cropping: false
      }, (error, result) => {
        if (!error && result && result.event === "success") {
          imagePreview.src = result.info.secure_url;
          imagePreview.style.display = 'block';
          imageUrlInput.value = result.info.secure_url;
        }
      });

      // Event listeners
      uploadImageBtn.addEventListener('click', (e) => {
        e.preventDefault();
        cloudinaryWidget.open();
      });

      submitPostBtn.addEventListener('click', async () => {
        const location = document.getElementById("postLocation").value.trim();
        const description = document.getElementById("postDescription").value.trim();
        const imageUrl = imageUrlInput.value;
        
        if (!description) {
          alert("Please add a description");
          return;
        }
        
        try {
          const userDoc = await db.collection("users").doc(user.uid).get();
          const userData = userDoc.exists ? userDoc.data() : {};
          
          await db.collection("communityFeed").add({
            location: location || null,
            description,
            imageUrl: imageUrl || null,
            authorId: user.uid,
            authorName: userData.name || user.email,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          document.getElementById("postLocation").value = '';
          document.getElementById("postDescription").value = '';
          imageUrlInput.value = '';
          imagePreview.style.display = 'none';
          imagePreview.src = '';
        } catch (error) {
          console.error("Error submitting post:", error);
          alert("Error submitting post. Please try again.");
        }
      });

      // Load and display posts
      function loadPosts(filters = {}) {
        db.collection("communityFeed")
          .orderBy("timestamp", "desc")
          .onSnapshot((snapshot) => {
            if (snapshot.empty) {
              postsContainer.innerHTML = '<div class="no-posts">No posts yet. Be the first to share!</div>';
              return;
            }
            
            postsContainer.innerHTML = '';
            snapshot.forEach((doc) => {
              const post = doc.data();
              const matchesLocation = filters.location ? 
                (post.location?.toLowerCase().includes(filters.location) || false) : true;
              const matchesKeyword = filters.keyword ? 
                (post.description?.toLowerCase().includes(filters.keyword) || false) : true;
              
              if (matchesLocation && matchesKeyword) {
                displayPost(post, doc.id);
              }
            });
          }, (error) => {
            console.error("Error loading posts:", error);
            postsContainer.innerHTML = '<div class="no-posts">Error loading posts. Please refresh the page.</div>';
          });
      }

      // Initial load
      loadPosts();

      function displayPost(post, docId) {
        const postCard = document.createElement('div');
        postCard.className = 'post-card';
        postCard.dataset.postId = docId;
        
        const postHeader = document.createElement('div');
        postHeader.className = 'post-header';
        
        const authorSpan = document.createElement('span');
        authorSpan.className = 'post-author';
        authorSpan.textContent = post.authorName || 'Anonymous';
        
        const timeSpan = document.createElement('span');
        timeSpan.className = 'post-time';
        if (post.timestamp && post.timestamp.toDate) {
          timeSpan.textContent = new Date(post.timestamp.toDate()).toLocaleString();
        } else {
          timeSpan.textContent = 'Just now';
        }
        
        postHeader.appendChild(authorSpan);
        postHeader.appendChild(timeSpan);
        postCard.appendChild(postHeader);
        
        if (post.location) {
          const locationDiv = document.createElement('div');
          locationDiv.className = 'post-location';
          locationDiv.textContent = `ðŸ“ ${post.location}`;
          postCard.appendChild(locationDiv);
        }
        
        if (post.imageUrl) {
          const img = document.createElement('img');
          img.className = 'post-image';
          img.src = post.imageUrl;
          img.alt = 'Post image';
          postCard.appendChild(img);
        }
        
        const descriptionDiv = document.createElement('div');
        descriptionDiv.className = 'post-description';
        descriptionDiv.textContent = post.description;
        postCard.appendChild(descriptionDiv);
        
        // Comments button
        const commentsBtn = document.createElement('button');
        commentsBtn.className = 'comments-btn';
        commentsBtn.textContent = 'ðŸ’¬ Comments';
        commentsBtn.addEventListener('click', toggleComments);
        postCard.appendChild(commentsBtn);

        // Report button
const reportBtn = document.createElement('button');
reportBtn.className = 'comments-btn';
reportBtn.innerHTML = 'âš ï¸ Report';
reportBtn.addEventListener('click', () => {
  showReportDialog(docId);
});
postCard.appendChild(reportBtn);

        // Comments section
        const commentsSection = document.createElement('div');
        commentsSection.className = 'comments-section';
        postCard.appendChild(commentsSection);
        
        postsContainer.appendChild(postCard);
      }

      function toggleComments(e) {
        const commentsSection = e.target.closest('.post-card').querySelector('.comments-section');
        commentsSection.classList.toggle('expanded');
        
        if (commentsSection.classList.contains('expanded')) {
          loadComments(commentsSection, e.target.closest('.post-card').dataset.postId);
        }
      }

      function loadComments(container, postId) {
        container.innerHTML = '<div class="comment">Loading comments...</div>';
        
        db.collection('communityFeed').doc(postId).collection('comments')
          .orderBy('timestamp', 'asc')
          .onSnapshot(snapshot => {
            container.innerHTML = '';
            
            if (snapshot.empty) {
              container.innerHTML = '<div class="comment">No comments yet</div>';
            }
            
            snapshot.forEach(doc => {
              const comment = doc.data();
              const commentDiv = document.createElement('div');
              commentDiv.className = 'comment';
              commentDiv.innerHTML = `
                <strong>${comment.authorName}:</strong> ${comment.text}
                <small>${new Date(comment.timestamp?.toDate()).toLocaleString()}</small>
              `;
              container.appendChild(commentDiv);
            });
            
            // Add comment form
            const commentForm = document.createElement('div');
            commentForm.className = 'comment-form';
            commentForm.innerHTML = `
              <input type="text" class="comment-input" placeholder="Write a comment...">
              <button class="comment-submit">Post</button>
            `;
            container.appendChild(commentForm);
            
            commentForm.querySelector('.comment-submit').addEventListener('click', () => {
              const text = commentForm.querySelector('.comment-input').value.trim();
              if (text) {
                addComment(postId, user, text);
                commentForm.querySelector('.comment-input').value = '';
              }
            });
          });
      }
async function createCommentNotification(postId, commenterName, postAuthorId) {
  try {
    // Don't create notification if the commenter is the post author
    const currentUser = auth.currentUser;
    if (currentUser.uid === postAuthorId) return;
    
    // Create notification in user's subcollection (no index needed)
    await db.collection("users")
      .doc(postAuthorId)
      .collection("notifications")
      .add({
        type: "comment",
        message: `${commenterName} commented on your post`,
        postId: postId,
        read: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
  } catch (error) {
    console.error("Error creating notification:", error);
  }
}
    
    // Fallback to old format if new format fails
    try {
      await db.collection("notifications")
        .doc(postAuthorId)
        .collection("alerts")
        .add({
          type: "comment",
          message: `${commenterName} commented on your post`,
          postId: postId,
          read: false,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (fallbackError) {
      console.error("Error creating notification in fallback format:", fallbackError);
    }
  }
}
      async function addComment(postId, user, text) {
  try {
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.exists ? userDoc.data() : {};
    
    // Get the post to find the author
    const postDoc = await db.collection('communityFeed').doc(postId).get();
    const postData = postDoc.data();
    
    await db.collection('communityFeed').doc(postId).collection('comments').add({
      text,
      authorId: user.uid,
      authorName: userData.name || user.email,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
    
    // Create notification for the post author
    if (postData.authorId) {
      createCommentNotification(postId, userData.name || user.email, postData.authorId);
    }
  } catch (error) {
    console.error("Error adding comment:", error);
    alert("Error adding comment. Please try again.");
  }
}

      // Filter posts
      applyFilterBtn.addEventListener('click', () => {
        const filters = {
          location: document.getElementById('locationFilter').value.toLowerCase(),
          keyword: document.getElementById('keywordFilter').value.toLowerCase()
        };
        loadPosts(filters);
      });

      // Show statistics
      showStatsBtn.addEventListener('click', showStatistics);
      closeModal.addEventListener('click', () => statsModal.style.display = 'none');

      async function showStatistics() {
        statsModal.style.display = 'block';
        
        const snapshot = await db.collection('communityFeed').get();
        const locationCounts = {};
        
        snapshot.forEach(doc => {
          const location = doc.data().location || 'Unknown';
          locationCounts[location] = (locationCounts[location] || 0) + 1;
        });
        
        const sortedLocations = Object.entries(locationCounts)
          .sort((a, b) => b[1] - a[1])
          .slice(0, 10);
        
        const ctx = document.getElementById('statsChart').getContext('2d');
        
        if (statsChart) {
          statsChart.destroy();
        }
        
        statsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: sortedLocations.map(item => item[0]),
            datasets: [{
              label: 'Number of Posts',
              data: sortedLocations.map(item => item[1]),
              backgroundColor: '#366de4',
            }]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      }

      document.getElementById("logoutBtn").addEventListener("click", () => {
        auth.signOut().then(() => window.location.href = "index.html");
      });
    }
    // Handle post highlighting from notifications
window.addEventListener('load', function() {
  const hash = window.location.hash;
  if (hash && hash.startsWith('#post-')) {
    const postId = hash.replace('#post-', '');
    setTimeout(() => {
      const postElement = document.querySelector(`[data-post-id="${postId}"]`);
      if (postElement) {
        postElement.scrollIntoView({ behavior: 'smooth' });
        postElement.style.backgroundColor = '#fff9e6';
        postElement.style.transition = 'background-color 2s';
        
        setTimeout(() => {
          postElement.style.backgroundColor = '';
        }, 2000);
      }
    }, 1000);
  }
});
  </script>
  <script>
  // Highlight active page in navigation
  document.addEventListener('DOMContentLoaded', function() {
    const currentPage = window.location.pathname.split('/').pop();
    const navLinks = document.querySelectorAll('.navbar .center a');
    
    navLinks.forEach(link => {
      const linkPage = link.getAttribute('href');
      if (linkPage === currentPage || (currentPage === '' && linkPage === 'index.html')) {
        link.classList.add('active');
      }
    });
  });
</script>
</body>
</html>